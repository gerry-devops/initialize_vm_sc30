---
- name: Install and configure Docker with proxy
  hosts: docker_hosts
  become: yes
  vars:
    proxy_url: "http://193.222.84.93:8080"
    proxy_env:
      http_proxy: "{{ proxy_url }}"
      https_proxy: "{{ proxy_url }}"
    no_proxy_list: "127.0.0.1,localhost,*.draco-449.sccloudres.net,*.mgmt-emm.local,*.sccloudinfra.net,private.cloud.swisscom.com,*.private.cloud.swisscom.com,ds12s3.swisscom.com,*.sharedit.ch,194.11.96.*,pcms2capsule-5.prd.cms.sccloudinfra.net"

  tasks:
    - name: 01 | Comment out proxy in yum.conf if it exists
      ansible.builtin.lineinfile:
        path: /etc/yum.conf
        regexp: '^(proxy="http://193.222.84.93:8080")'
        line: '#\1'
        backrefs: yes

    - name: 02 | Add Docker CE repository file (MIT PROXY)
      ansible.builtin.get_url:
        url: https://download.docker.com/linux/rhel/docker-ce.repo
        dest: /etc/yum.repos.d/docker-ce.repo
        mode: '0644'
      environment: "{{ proxy_env }}" # Proxy wird nur für diesen Download-Task verwendet

    - name: 03 | Set proxy specifically for docker-ce.repo
      ansible.builtin.ini_file:
        path: /etc/yum.repos.d/docker-ce.repo
        section: docker-ce-stable 
        option: proxy
        value: "{{ proxy_url }}"
        state: present
        no_extra_spaces: yes
      notify: Refresh DNF Cache

    - name: 04 | Install Docker packages
      ansible.builtin.dnf:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
      notify: Refresh DNF Cache
      # dnf wird den Proxy aus der .repo-Datei (Task 03) lesen

    - name: 05 | Start and enable Docker service
      ansible.builtin.systemd:
        name: docker
        state: started
        enabled: yes

    - name: 06 | Add ansible user to docker group
      ansible.builtin.user:
        name: "{{ ansible_user_id }}"
        groups: docker
        append: yes

    - name: 07 | Notify user to re-login
      ansible.builtin.debug:
        msg: "Benutzer '{{ ansible_user_id }}' wurde zur 'docker' Gruppe hinzugefügt. Ein erneuter Login (logout/login) ist erforderlich, damit dies wirksam wird."

    - name: 08 | Create systemd directory for Docker proxy
      ansible.builtin.file:
        path: /etc/systemd/system/docker.service.d
        state: directory
        mode: '0755'

    - name: 09 | Create http-proxy.conf for Docker daemon
      ansible.builtin.copy:
        dest: /etc/systemd/system/docker.service.d/http-proxy.conf
        content: |
          [Service]
          Environment="HTTP_PROXY={{ proxy_url }}"
          Environment="HTTPS_PROXY={{ proxy_url }}"
          Environment="NO_PROXY={{ no_proxy_list }}"
        mode: '0644'
      notify: Restart Docker

    - name: 10 | Ensure handlers are flushed to apply changes
      ansible.builtin.meta: flush_handlers

    - name: 11 | Check Docker service status
      ansible.builtin.command: systemctl status docker
      changed_when: false
      register: docker_status

    - name: 12 | Display Docker status
      ansible.builtin.debug:
        var: docker_status.stdout_lines

    - name: 13 | Check Docker proxy environment
      ansible.builtin.command: systemctl show docker -p Environment --no-pager
      changed_when: false
      register: docker_env

    - name: 14 | Display Docker proxy environment
      ansible.builtin.debug:
        var: docker_env.stdout_lines

  handlers:
    - name: Refresh DNF Cache
      ansible.builtin.command: dnf makecache
      changed_when: false

    - name: Restart Docker
      ansible.builtin.systemd:
        name: docker
        state: restarted
        daemon_reload: yes